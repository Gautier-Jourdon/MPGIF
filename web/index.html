<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPGIF Interactive Player</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #111;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        #gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            width: 90%;
            max-width: 1200px;
        }

        .mpgif-container {
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            aspect-ratio: 16/9;
            /* Default aspect, adjusts JS */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mpgif-container:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            border: 2px solid #ff9800;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }

        .meta-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            font-size: 0.85em;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mpgif-container:hover .meta-overlay {
            transform: translateY(0);
        }

        .badge {
            background: #ff9800;
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.75em;
            margin-right: 5px;
        }

        #drop-zone {
            border: 2px dashed #444;
            padding: 40px;
            margin-top: 20vh;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            color: #888;
        }

        #drop-zone:hover {
            border-color: #ff9800;
            color: #fff;
            background: #222;
        }

        input[type="range"] {
            width: 80px;
            accent-color: #ff9800;
        }

        .upload-mod {
            display: block;
        }

        .gallery-mod {
            display: none;
            width: 100%;
        }
    </style>
</head>

<body>

    <div id="drop-zone" onclick="document.getElementById('file-input').click()">
        <h2>ðŸ“‚ Drag & Drop MPGIF files here</h2>
        <p>or click to browse</p>
    </div>
    <input type="file" id="file-input" accept=".mpgif" multiple style="display:none">

    <div id="gallery" class="gallery-mod">
        <!-- MPGIF Items will be injected here -->
    </div>

    <script src="mpgif_reader.js"></script>
    <script>
        const gallery = document.getElementById('gallery');
        const dropZone = document.getElementById('drop-zone');
        let globalVolume = 0.5;

        // --- Drag & Drop ---
        document.body.ondragover = e => e.preventDefault();
        document.body.ondrop = e => {
            e.preventDefault();
            handleFiles(e.dataTransfer.files);
        };
        document.getElementById('file-input').onchange = e => handleFiles(e.target.files);

        function handleFiles(files) {
            if (files.length > 0) {
                dropZone.style.display = 'none';
                gallery.style.display = 'grid';
                Array.from(files).forEach(file => {
                    if (file.name.toLowerCase().endsWith('.mpgif')) {
                        loadMPGIF(file);
                    }
                });
            }
        }

        // --- Core Loading & Display Logic ---
        function loadMPGIF(file) {
            const fr = new FileReader();
            fr.onload = async () => {
                try {
                    const mpgif = new MPGIFReader(fr.result);
                    mpgif.read();
                    createViewer(mpgif);
                } catch (e) {
                    console.error("Error loading", file.name, e);
                }
            };
            fr.readAsArrayBuffer(file);
        }

        async function createViewer(mpgif) {
            // Unpack images (async)
            const images = await Promise.all(mpgif.frames.map(src => {
                return new Promise(resolve => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => resolve(img);
                });
            }));

            // DOM Construction
            const container = document.createElement('div');
            container.className = 'mpgif-container';
            container.style.aspectRatio = `${mpgif.width}/${mpgif.height}`;

            const canvas = document.createElement('canvas');
            canvas.width = mpgif.width;
            canvas.height = mpgif.height;
            const ctx = canvas.getContext('2d');

            // Draw thumbnail (first frame)
            if (images.length > 0) ctx.drawImage(images[0], 0, 0);

            // Metadata UI
            const metaDiv = document.createElement('div');
            metaDiv.className = 'meta-overlay';
            const title = mpgif.metadata?.title || "Untitled";
            const author = mpgif.metadata?.author || "Unknown";
            const hasAudio = mpgif.audioData ? "ðŸ”Š" : "ðŸ”‡";

            metaDiv.innerHTML = `
                <div>
                    <span class="badge">MPGIF</span>
                    <b>${title}</b> by ${author}
                </div>
                <div>${hasAudio}</div>
            `;

            container.appendChild(canvas);
            container.appendChild(metaDiv);
            gallery.appendChild(container);

            // Audio Setup
            let audioCtx = null;
            let audioBuffer = null;
            let audioSource = null;
            let gainNode = null;

            if (mpgif.audioData) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                try {
                    audioBuffer = await audioCtx.decodeAudioData(mpgif.audioData.slice(0));
                } catch (e) { console.warn("Audio decode failed", e); }
            }

            // Hover Logic
            let interval = null;
            let frameIdx = 0;

            const play = () => {
                // Video
                if (!interval) {
                    interval = setInterval(() => {
                        frameIdx = (frameIdx + 1) % images.length;
                        ctx.drawImage(images[frameIdx], 0, 0);
                    }, 1000 / mpgif.fps);
                }

                // Audio
                if (audioCtx && audioBuffer) {
                    if (audioSource) audioSource.stop();
                    audioSource = audioCtx.createBufferSource();
                    audioSource.buffer = audioBuffer;
                    audioSource.loop = (mpgif.loopCount === 0);

                    gainNode = audioCtx.createGain();
                    gainNode.gain.value = globalVolume; // Cap at 0.5 for safety

                    audioSource.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    audioSource.start();
                }
            };

            const stop = () => {
                if (interval) {
                    clearInterval(interval);
                    interval = null;
                }
                // Reset to first frame
                frameIdx = 0;
                ctx.drawImage(images[0], 0, 0);

                // Stop Audio
                if (audioSource) {
                    try { audioSource.stop(); } catch (e) { }
                    audioSource = null;
                }
            };

            container.addEventListener('mouseenter', play);
            container.addEventListener('mouseleave', stop);

            // Click to toggle static play (mobile friendly-ish)
            container.addEventListener('click', () => {
                if (interval) stop(); else play();
            });
        }
    </script>
</body>

</html>