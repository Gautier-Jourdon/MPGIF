<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Endfield MPGIF Terminal</title>
    <style>
        :root {
            /* Endfield "Wedge" Palette - Intense High Contrast */
            --primary: #FFD54F;
            /* Arclight Yellow */
            --primary-glow: rgba(255, 213, 79, 0.4);
            --bg: #141419;
            --surface: #1E1E24;
            --surface-light: #2B2C33;
            --text-main: #FFFFFF;
            --text-sec: #888890;
            --border: #3A3A45;
            --modal-bg: rgba(15, 15, 20, 0.95);

            --tech-font: 'Consolas', 'Monaco', monospace;
            --ui-font: 'Segoe UI', 'Roboto', sans-serif;

            /* Rarity Colors */
            --rarity-3: #81D4FA;
            /* Bot */
            --rarity-4: #CE93D8;
            /* Normal */
            --rarity-5: #FFB74D;
            /* Senior */
            --rarity-6: #E57373;
            /* Admin */
        }

        body.light-theme {
            --bg: #EAEAEF;
            --surface: #F4F4F9;
            --surface-light: #FFFFFF;
            --text-main: #141419;
            --text-sec: #555560;
            --border: #B0B0C0;
            --modal-bg: rgba(240, 240, 245, 0.95);
        }

        /* Light Theme overrides for the Tutorial Dialog */
        body.light-theme #ember-dialog {
            background: #FFFFFF;
            border-color: #D3A92A;
        }

        body.light-theme #ember-dialog .dialog-text {
            color: #141419;
            font-weight: 500;
        }

        body.light-theme #ember-dialog .dialog-header {
            color: #B58D14;
            border-bottom-color: rgba(181, 141, 20, 0.3);
        }

        body.light-theme #ember-dialog .btn-tut {
            color: #B58D14;
            border-color: #B58D14;
        }

        body.light-theme #ember-dialog .btn-tut:hover {
            background: #D3A92A;
            color: #FFF;
        }

        body {
            margin: 0;
            background-color: var(--bg);
            /* Wedge Style Pattern - Intense */
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 40px, rgba(255, 255, 255, 0.02) 40px, rgba(255, 255, 255, 0.02) 41px),
                repeating-linear-gradient(-45deg, transparent, transparent 40px, rgba(255, 255, 255, 0.02) 40px, rgba(255, 255, 255, 0.02) 41px),
                linear-gradient(180deg, var(--bg) 0%, rgba(20, 20, 25, 0.9) 100%);
            color: var(--text-main);
            font-family: var(--ui-font);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        /* ___ HEADER ___ */
        header {
            height: 70px;
            background: var(--surface);
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            z-index: 100;
        }

        .brand {
            font-family: var(--tech-font);
            font-weight: 800;
            font-size: 1.6rem;
            letter-spacing: 2px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand span {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
            font-size: 1.8rem;
        }

        .search-container {
            position: relative;
        }

        .search-bar input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-left: 3px solid var(--primary);
            padding: 10px 15px;
            color: var(--text-main);
            font-family: var(--tech-font);
            width: 300px;
            transition: all 0.3s;
        }

        .search-bar input:focus {
            width: 400px;
            border-color: var(--primary);
            outline: none;
            background: rgba(255, 213, 79, 0.05);
        }

        .search-bar::before {
            content: '//';
            position: absolute;
            right: 10px;
            top: 10px;
            color: var(--primary);
            font-family: var(--tech-font);
            font-weight: bold;
            pointer-events: none;
        }

        .header-tools {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 16px;
            cursor: pointer;
            font-family: var(--tech-font);
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s;
        }

        .btn:hover::after {
            width: 100%;
        }

        .btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(255, 213, 79, 0.1);
        }

        .btn.primary {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            box-shadow: 0 0 10px var(--primary-glow);
        }

        .btn.primary:hover {
            background: #fff;
            border-color: #fff;
            color: #000;
        }

        /* ___ SERVER PANEL ___ */
        .server-trigger {
            position: relative;
            padding: 0 20px;
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .server-trigger:hover,
        .server-trigger.active {
            background: rgba(255, 255, 255, 0.05);
        }

        .server-panel {
            position: absolute;
            top: 55px;
            right: -1px;
            width: 340px;
            background: var(--surface);
            border: 1px solid var(--primary);
            border-top: none;
            display: none;
            z-index: 500;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
        }

        .server-panel.visible {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .server-banner {
            height: 120px;
            background: var(--surface-light);
            position: relative;
            background-size: cover;
            background-position: center;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .server-default-text {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            font-family: var(--tech-font);
            text-transform: uppercase;
            letter-spacing: 5px;
            pointer-events: none;
            text-align: center;
            line-height: 1.2;
        }

        .server-info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 10px 15px;
            box-sizing: border-box;
            color: #fff;
            font-family: var(--tech-font);
            font-weight: bold;
        }

        /* ___ NAV PROFILE ___ */
        .nav-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .nav-profile:hover {
            border-color: var(--primary);
            background: rgba(255, 213, 79, 0.05);
        }

        .nav-avatar-wrapper {
            width: 42px;
            height: 42px;
            position: relative;
            /* Default rarity color border */
            border: 2px solid var(--rarity-4);
            border-radius: 4px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .nav-avatar-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ___ GRID SYSTEM ___ */
        .wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 60px;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 150px;
            height: 2px;
            background: var(--primary);
        }

        .section-title {
            font-family: var(--tech-font);
            font-size: 1.5rem;
            color: var(--text-sec);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: 1px;
        }

        .section-title span {
            color: var(--primary);
            font-weight: bold;
            font-size: 1.8rem;
        }

        .gallery-grid {
            display: grid;
            gap: 20px;
        }

        #grid-shorts {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        #grid-videos {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        /* ___ INTENSE CARD STYLING ___ */
        .card {
            background: var(--surface-light);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease-out;
            position: relative;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 10px;
            height: 10px;
            border-top: 2px solid #fff;
            border-left: 2px solid #fff;
            z-index: 10;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .card::after {
            content: '//';
            position: absolute;
            top: 10px;
            right: 10px;
            font-family: var(--tech-font);
            color: var(--primary);
            font-weight: bold;
            z-index: 10;
            opacity: 0;
            transition: all 0.2s;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--primary);
        }

        .card:hover::before {
            opacity: 1;
            border-color: var(--primary);
        }

        .card:hover::after {
            opacity: 1;
            transform: translateX(-5px);
        }

        .media-box {
            position: relative;
            background: #050508;
            width: 100%;
            flex-grow: 1;
            min-height: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: crosshair;
            /* Indicate clickable to post */
        }

        .media-box::after {
            /* Hover hint for posting */
            content: 'CLICK TO POST';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            color: var(--primary);
            font-family: var(--tech-font);
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .media-box:hover::after {
            opacity: 1;
        }

        #grid-shorts .card {
            aspect-ratio: 9/16;
        }

        #grid-videos .card {
            aspect-ratio: 16/9;
        }

        .media-box canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-body {
            padding: 12px;
            background: var(--surface);
            z-index: 2;
            border-top: 1px solid var(--border);
            font-family: var(--tech-font);
            position: relative;
        }

        .card-body::before {
            content: '';
            position: absolute;
            bottom: 5px;
            right: 10px;
            width: 40px;
            height: 8px;
            background: repeating-linear-gradient(90deg, var(--border), var(--border) 2px, transparent 2px, transparent 4px);
            opacity: 0.5;
        }

        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filename {
            font-size: 0.85rem;
            color: var(--text-sec);
            max-width: 140px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 2;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-sec);
            font-size: 1.1rem;
            padding: 5px;
            transition: color 0.2s;
        }

        .icon-btn-vote {
            font-size: 0.9rem;
            margin-top: -2px;
        }

        .icon-btn:hover {
            color: var(--text-main);
        }

        .icon-btn.active {
            color: var(--primary);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        /* ___ ENDFIELD OPERATOR FILE MODAL ___ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            perspective: 1200px;
            /* For 3D animation */
        }

        .operator-file {
            width: 90vw;
            max-width: 1400px;
            height: 85vh;
            display: flex;
            background: var(--bg);
            /* Outer File Border uses Javascript to set --op-border-color based on rarity */
            border: 3px solid var(--op-border-color, var(--rarity-4));
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), inset 0 0 100px rgba(0, 0, 0, 0.5);
            position: relative;
            transform-origin: left center;
            animation: folderOpen 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        @keyframes folderOpen {
            from {
                transform: rotateY(-90deg) translateX(-500px);
                opacity: 0;
            }

            to {
                transform: rotateY(0deg) translateX(0);
                opacity: 1;
            }
        }

        /* Back Arrow */
        .op-back {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border);
        }

        /* ___ TAGS & WARNINGS ___ */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
            min-height: 20px;
        }

        .tag-badge {
            font-size: 0.65rem;
            color: #141419;
            background: var(--primary);
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .warning-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            z-index: 10;
        }

        .warn-blue {
            background: #4FC3F7;
            color: #000;
            box-shadow: 0 0 10px #4FC3F7;
        }

        .warn-yellow {
            background: #FFF176;
            color: #000;
            box-shadow: 0 0 10px #FFF176;
        }

        .warn-orange {
            background: #FFB74D;
            color: #000;
            box-shadow: 0 0 10px #FFB74D;
        }

        .warn-red {
            background: #E57373;
            color: #FFF;
            box-shadow: 0 0 10px #E57373;
        }

        .op-back {
            color: #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .op-back:hover {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            transform: translateX(-5px);
        }

        /* Left Side: Avatar Display */
        .op-left {
            flex: 1;
            position: relative;
            border-right: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.05) 0%, transparent 60%);
            overflow: hidden;
        }

        .op-avatar {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 95%;
            width: 150%;
            max-width: 900px;
            object-fit: contain;
            object-position: bottom center;
            pointer-events: none;
            filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.8));
        }

        .op-name-plate {
            position: absolute;
            bottom: 30px;
            left: 30px;
            z-index: 10;
            width: 90%;
        }

        .op-name {
            font-size: 3.5rem;
            font-weight: 800;
            color: #fff;
            letter-spacing: -2px;
            line-height: 1;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.9);
            font-family: var(--ui-font);
            word-break: break-all;
        }

        .op-stars {
            display: flex;
            gap: 3px;
            margin-top: 5px;
        }

        .op-stars img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }

        /* Right Side: Data Panels */
        .op-right {
            width: 55%;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            position: relative;
        }

        /* Folded Archive Background overlay */
        .op-right::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background-image: repeating-linear-gradient(45deg, var(--border) 0, var(--border) 1px, transparent 1px, transparent 10px);
            opacity: 0.1;
            pointer-events: none;
            clip-path: polygon(100% 100%, 0 100%, 100% 0);
        }

        /* Top Tabs (Operator File, etc) */
        .op-tabs-header {
            display: flex;
            background: var(--surface-light);
            border-bottom: 2px solid var(--border);
        }

        .op-top-tab {
            padding: 20px 40px;
            font-family: var(--ui-font);
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-sec);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .op-top-tab:hover {
            color: var(--text-main);
            background: rgba(0, 0, 0, 0.1);
        }

        .op-top-tab.active {
            background: var(--surface);
            color: var(--text-main);
            border-top: 4px solid var(--text-main);
        }

        .op-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Folder Style Panels */
        .op-folder {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Top "Tab" of the folder */
        .op-folder-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            font-family: var(--tech-font);
            font-size: 0.75rem;
            color: var(--text-sec);
        }

        .op-folder-header::before {
            content: 'üìÅ';
            margin-right: 10px;
            font-size: 1rem;
            opacity: 0.7;
        }

        .op-folder-title {
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-main);
            border-left: 4px solid var(--primary);
            /* Accent line */
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            font-family: var(--ui-font);
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .op-folder-body {
            padding: 20px;
            font-family: var(--ui-font);
            color: var(--text-sec);
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .op-folder-body strong {
            color: var(--text-main);
        }

        .tech-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        textarea.op-input {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-family: var(--ui-font);
            padding: 15px;
            resize: vertical;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        textarea.op-input:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* General Modals (Upload, Converter) */
        .dossier-panel {
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-top: 4px solid var(--primary);
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .panel-head {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-family: var(--tech-font);
            color: var(--text-sec);
            font-weight: bold;
        }

        /* Converter Results */
        .c-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid var(--border);
        }

        .c-item span {
            font-family: var(--tech-font);
            font-size: 0.85rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            border: 1px solid var(--primary);
            padding: 10px 30px;
            display: none;
            z-index: 2000;
            font-family: var(--tech-font);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            font-weight: bold;
        }

        /* ___ TUTORIAL OVERLAY SYSTEM ___ */
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
            display: none;
            pointer-events: all;
            /* Block clicks */
            background: transparent;
        }

        #tutorial-overlay.active {
            display: block;
        }

        #tutorial-hole {
            position: absolute;
            box-shadow: 0 0 0 9999px rgba(10, 10, 15, 0.85);
            /* The dark mask */
            border-radius: 12px;
            transition: all 0.4s ease-out;
            pointer-events: none;
            opacity: 0;
        }

        /* The dialog box Endfield style */
        #ember-dialog {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            width: 90%;
            max-width: 800px;
            background: var(--surface);
            border: 2px solid var(--primary);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8), 0 0 20px rgba(255, 213, 79, 0.2);
            z-index: 2001;
            display: flex;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s, transform 0.4s;
        }

        #tutorial-overlay.active~#ember-dialog {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: all;
        }

        #tut-chibi-floating {
            position: fixed;
            width: 250px;
            height: 250px;
            z-index: 2003;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        #tutorial-overlay.active~#tut-chibi-floating {
            opacity: 1;
        }

        #tut-chibi-floating img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(5px 5px 15px rgba(0, 0, 0, 0.8));
        }



        #ember-dialog .dialog-content {
            flex-grow: 1;
            padding: 25px 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 150px;
        }

        #ember-dialog .dialog-header {
            font-family: var(--tech-font);
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(255, 213, 79, 0.3);
            padding-bottom: 5px;
        }

        #ember-dialog .dialog-text {
            font-size: 1.05rem;
            line-height: 1.5;
            color: var(--text-main);
            flex-grow: 1;
        }

        #ember-dialog .dialog-controls {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 15px;
        }

        #ember-dialog .btn-tut {
            background: rgba(255, 213, 79, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 20px;
            cursor: pointer;
            font-family: var(--tech-font);
            font-weight: bold;
            transition: all 0.2s;
        }

        #ember-dialog .btn-tut:hover {
            background: var(--primary);
            color: #000;
        }

        /* Class to bring elements above the mask */
        .tut-highlight {
            position: relative !important;
            z-index: 2002 !important;
            /* Above mask */
            box-shadow: 0 0 0 4px var(--primary), 0 0 30px var(--primary-glow) !important;
            border-radius: 4px;
            background: var(--surface) !important;
            /* Ensure it stays opaque */
            pointer-events: auto !important;
            /* Prevent user clicking during tut */
            animation: pulse-tut 2s infinite;
        }

        @keyframes pulse-tut {
            0% {
                box-shadow: 0 0 0 4px var(--primary), 0 0 20px var(--primary-glow);
            }

            50% {
                box-shadow: 0 0 0 6px var(--primary), 0 0 40px var(--primary-glow);
            }

            100% {
                box-shadow: 0 0 0 4px var(--primary), 0 0 20px var(--primary-glow);
            }
        }

        /* ___ CATEGORIES & LEADERBOARD UI ___ */
        .category-nav {
            display: flex;
            gap: 15px;
            padding: 15px 40px;
            background: rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .cat-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-sec);
            font-family: var(--tech-font);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .cat-btn:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.05);
        }

        .cat-btn.active {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(255, 213, 79, 0.1);
            text-shadow: 0 0 5px var(--primary-glow);
        }

        .lb-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 213, 79, 0.2);
            transition: background 0.2s;
        }

        .lb-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lb-rank {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            width: 40px;
            text-align: center;
            font-family: var(--tech-font);
        }

        .lb-userinfo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-grow: 1;
        }

        .lb-avatar {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            border: 1px solid var(--primary);
            object-fit: cover;
        }

        .lb-stats {
            text-align: right;
            font-family: var(--tech-font);
            font-size: 0.85rem;
            color: var(--text-sec);
            min-width: 100px;
        }
    </style>
</head>

<body>
    <div class="bg-deco"></div>

    <header>
        <div class="header-tools">
            <div class="brand"><span>//</span> END-G</div>
            <div class="search-container">
                <input type="text" class="search-bar" id="searchInput" placeholder="SEARCH_DATABASE...">
            </div>
        </div>

        <div class="header-tools">
            <button class="btn" id="converterBtn"
                onclick="document.getElementById('converterModal').style.display='flex'"><i>‚Ü∫</i> CONVERT</button>
            <button class="btn" onclick="toggleFavs()" id="favBtn"><i>‚òÖ</i> FAVS</button>
            <button class="btn" id="hofBtn" onclick="openLeaderboard()"><i>üèÜ</i> FAME</button>
            <button class="btn" onclick="toggleTheme()" id="themeBtn"><i>‚òÄ</i></button>
            <button class="btn" onclick="startTutorial()" id="helpBtn" title="Help / Tutorial"><i>?</i></button>
            <button class="btn primary" id="uploadBtn"
                onclick="document.getElementById('uploadModal').style.display='flex'"><i>+</i> UPLOAD</button>

            <!-- Server Panel Trigger -->
            <div class="server-trigger" id="serverTrigger" onclick="toggleServerPanel()">
                <div style="font-size:0.7rem; color:var(--text-sec); letter-spacing:1px; text-align:right;">LINK</div>
                <div style="font-weight:bold; color:var(--primary); font-family:var(--tech-font); text-align:right;"
                    id="serverName">OFFLINE</div>

                <div class="server-panel" id="serverPanel" onclick="event.stopPropagation()">
                    <div class="server-banner" id="serverBanner">
                        <div class="server-default-text">ENDFIELD<br><span
                                style="font-size:0.8rem; color:var(--primary);">INDUSTRIES</span></div>
                        <div class="server-info-overlay" id="serverBannerName">DISCONNECTED</div>
                    </div>
                    <div style="padding:15px; color:var(--text-sec); font-size:0.8rem; font-family:var(--tech-font);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span>ACTIVE PERSONNEL:</span>
                            <span style="color:var(--text-main); font-weight:bold;" id="serverMembers">UNKNOWN</span>
                        </div>
                        <div style="margin-bottom:5px;">CHANNEL_FREQUENCY:</div>
                        <select id="channelSelect"
                            style="width:100%; background:rgba(0,0,0,0.5); color:var(--text-main); border:1px solid var(--border); padding:8px; font-family:var(--tech-font);">
                            <option>LOADING...</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Navbar Profile -->
            <div class="nav-profile" onclick="openProfile(userId)">
                <div style="text-align:right;">
                    <div id="navUser" style="font-weight:bold; font-size:0.9rem;">GUEST</div>
                    <div id="navId" style="font-size:0.75rem; color:var(--text-sec);">ID: -</div>
                </div>
                <div class="nav-avatar-wrapper" id="navAvatarWrapper">
                    <img id="navAvatar" src="https://cdn.discordapp.com/embed/avatars/0.png">
                </div>
            </div>
        </div>
    </header>

    <div class="category-nav" id="categoryNav">
        <button class="cat-btn active" onclick="setCategory('')">ALL FILES</button>
        <button class="cat-btn" onclick="setCategory('auto-tagged')">AI TAGGED</button>
        <button class="cat-btn" onclick="setCategory('gaming')">GAMING</button>
        <button class="cat-btn" onclick="setCategory('anime')">ANIME</button>
        <button class="cat-btn" onclick="setCategory('reaction')">REACTION</button>
        <button class="cat-btn" onclick="setCategory('meme')">MEME</button>
    </div>

    <div class="wrapper">
        <div id="s-shorts">
            <div class="section-header">
                <h2 class="section-title"><span>//</span> SHORTS</h2>
            </div>
            <div class="gallery-grid" id="grid-shorts"></div>
        </div>
        <div id="s-videos">
            <div class="section-header">
                <h2 class="section-title"><span>//</span> VIDEOS</h2>
            </div>
            <div class="gallery-grid" id="grid-videos"></div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer
        style="text-align:center; padding: 20px; font-family: var(--tech-font); font-size: 0.8rem; color: var(--text-sec); border-top: 1px solid var(--border); margin-top: 50px; background: rgba(0,0,0,0.5);">
        MPGIF Terminal OS ¬© 2026 Gautier Jourdon.<br>
        <span onclick="document.getElementById('disclaimerModal').style.display='flex'"
            style="color: var(--primary); cursor: pointer; text-decoration: underline; margin-top: 10px; display: inline-block;"
            id="disclaimerBtn">Acte de Non-Licence / Disclaimer</span>
    </footer>

    <div id="toast">SYSTEM ALERT</div>

    <!-- LEADERBOARD MODAL -->
    <div class="modal-overlay" id="leaderboardModal">
        <div class="dossier-panel" style="width:600px; max-height:85vh; display:flex; flex-direction:column;">
            <div class="panel-head" style="margin-bottom: 20px;">
                <span>HALL OF FAME</span>
                <span onclick="document.getElementById('leaderboardModal').style.display='none'"
                    style="cursor:pointer; color:var(--primary);">[X]</span>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:15px; font-family:var(--tech-font);">
                <button class="btn primary" id="sortScoreBtn" onclick="loadLeaderboard('score')"
                    style="flex:1; justify-content:center;">TOP REPUTATION</button>
                <button class="btn" id="sortUploadsBtn" onclick="loadLeaderboard('uploads')"
                    style="flex:1; justify-content:center;">TOP UPLOADERS</button>
            </div>

            <div id="leaderboardList" style="flex:1; overflow-y:auto; padding-right:10px;">
                <!-- Filled via JS -->
                <div style="text-align:center; padding:30px; color:var(--text-sec); font-family:var(--tech-font);">
                    FETCHING INTEL...</div>
            </div>
        </div>
    </div>

    <!-- DISCLAIMER MODAL -->
    <div class="modal-overlay" id="disclaimerModal">
        <div class="dossier-panel"
            style="width:500px; max-height:80vh; overflow-y:auto; line-height: 1.5; font-family:var(--ui-font);">
            <div class="panel-head" style="margin-bottom: 20px;"><span>ACTE DE NON-LICENCE</span> <span
                    onclick="document.getElementById('disclaimerModal').style.display='none'"
                    style="cursor:pointer; color:var(--primary);">[X]</span></div>

            <strong style="color:var(--text-main); font-family:var(--tech-font);">Projet : MPGIF<br>
                Auteur : Gautier Jourdon<br>
                Date : 2026</strong><br><br>

            <span style="color:var(--primary); font-weight:bold;">1 - Absence de licence officielle</span><br>
            <span style="color:var(--text-sec);">Le projet MPGIF n‚Äôest pas affili√©, soutenu, ni approuv√© par Yostar,
                Hypergryph, ou tout autre ayant droit li√© √† l‚Äôunivers Arknights Endfield. Aucun droit officiel n‚Äôest
                d√©tenu ou accord√© pour l‚Äôutilisation de ce projet.</span><br><br>

            <span style="color:var(--primary); font-weight:bold;">2 - Utilisation d‚Äô√©l√©ments inspir√©s</span><br>
            <span style="color:var(--text-sec);">Les visuels, personnages ou √©l√©ments graphiques pr√©sents dans ce projet
                sont inspir√©s de l‚Äôunivers original et/ou cr√©√©s de mani√®re originale ou via IA. Aucune reproduction
                exacte d‚Äôassets officiels n‚Äôest utilis√©e.</span><br><br>

            <span style="color:var(--primary); font-weight:bold;">3 - But non lucratif</span><br>
            <span style="color:var(--text-sec);">Ce projet est strictement non commercial et non lucratif, destin√© √† un
                usage personnel ou communautaire limit√© (ex. : serveur Discord priv√©).</span><br><br>

            <span style="color:var(--primary); font-weight:bold;">4 - Respect des droits d‚Äôauteur</span><br>
            <span style="color:var(--text-sec);">Si les ayants droit demandent la suppression d‚Äôun contenu ou d‚Äôun
                √©l√©ment du projet, celui-ci sera imm√©diatement retir√© ou modifi√© pour respecter leurs
                droits.</span><br><br>

            <span style="color:var(--primary); font-weight:bold;">5 - Responsabilit√©</span><br>
            <span style="color:var(--text-sec);">L‚Äôutilisateur reconna√Æt que ce projet n‚Äôaccorde aucun droit de
                propri√©t√© intellectuelle sur l‚Äôunivers ou les personnages mentionn√©s. Toute utilisation de ce projet se
                fait √† ses propres risques et dans le respect des droits d‚Äôauteur.</span><br><br>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div class="modal-overlay" id="uploadModal">
        <div class="dossier-panel" style="width:400px; max-height:80vh; overflow-y:auto;">
            <div class="panel-head"><span>UPLOAD PROTOCOL</span> <span
                    onclick="document.getElementById('uploadModal').style.display='none'"
                    style="cursor:pointer; color:var(--primary);">[X]</span></div>
            <div style="border:2px dashed var(--border); padding:40px 20px; text-align:center; margin-bottom:20px; cursor:pointer; background:rgba(0,0,0,0.2); font-family:var(--tech-font); color:var(--text-sec);"
                onclick="document.getElementById('fIn').click()" id="dropZ">
                [ DRAG & DROP OR CLICK TO UPLOAD ]
            </div>
            <input type="file" id="fIn" hidden accept=".mpgif" multiple onchange="handleFileSelect(event)">

            <div id="uploadList" style="margin-bottom: 20px; display: none;">
                <div class="panel-head" style="font-size:0.8rem; border:none; margin-bottom:5px;"><span>SELECTED
                        FILES_</span></div>
                <div id="uploadFilesCont" style="max-height: 150px; overflow-y:auto; margin-bottom: 10px;"></div>
            </div>

            <input type="text" id="upName" placeholder="CODENAME (OPTIONAL, APPLIES TO 1ST)..."
                style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:var(--text-main); padding:10px; margin-bottom:15px; font-family:var(--tech-font); box-sizing:border-box;">
            <button class="btn primary" id="doUploadBtn" style="width:100%; justify-content:center; display:none;"
                onclick="doUpload()">INITIATE UPLOAD</button>
        </div>
    </div>

    <!-- CONVERTER MODAL -->
    <div class="modal-overlay" id="converterModal">
        <div class="dossier-panel" style="width:400px; max-height: 80vh; overflow-y:auto;">
            <div class="panel-head"><span>VIDEO CONVERTER</span> <span onclick="closeConverter()"
                    style="cursor:pointer; color:var(--primary);">[X]</span></div>
            <p style="font-family:var(--tech-font); font-size:0.8rem; color:var(--text-sec); margin-top:0;">Select
                multiple .mp4 files to batch convert to .mpgif.</p>
            <input type="file" id="cIn" multiple accept=".mp4,.gif"
                style="margin-bottom:15px; width:100%; color:var(--text-main); font-family:var(--ui-font);">

            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;">
                    <label style="font-size:0.7rem; color:var(--text-sec);">START TIME (s)</label>
                    <input type="number" id="cStart" class="op-input" placeholder="0" min="0" step="1"
                        style="width:100%; padding:5px;">
                </div>
                <div style="flex:1;">
                    <label style="font-size:0.7rem; color:var(--text-sec);">END TIME (s)</label>
                    <input type="number" id="cEnd" class="op-input" placeholder="End" min="0" step="1"
                        style="width:100%; padding:5px;">
                </div>
            </div>

            <label
                style="display:block; margin-bottom: 20px; font-family:var(--tech-font); font-size:0.8rem; color:var(--text-main); cursor:pointer; background: rgba(0,0,0,0.3); padding:10px; border-radius:4px; border:1px solid var(--border);">
                <input type="checkbox" id="cAutoUpload" style="margin-right:8px; accent-color:var(--primary);">
                [AUTO-UPLOAD] Push automatically to Main Terminal after conversion
            </label>
            <button class="btn primary" id="convBtn" style="width:100%; justify-content:center;"
                onclick="doConvert()">CONVERT FORMAT</button>

            <!-- Conversions list -->
            <div id="cResults"
                style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px; display:none;">
                <div class="panel-head" style="font-size:0.8rem; border:none; margin-bottom:5px;">
                    <span>CONVERSION LOGS_</span>
                    <span onclick="clearConversions()" style="cursor:pointer; color:#E57373;">[CLEAR]</span>
                </div>
                <div id="cLog" style="max-height: 150px; overflow-y:auto; margin-bottom: 10px;"></div>
                <a id="cZip" href="#" style="text-decoration:none;"><button class="btn"
                        style="width:100%; justify-content:center; border-color:var(--rarity-3); color:var(--rarity-3);">DOWNLOAD
                        ALL (.ZIP)</button></a>
            </div>
        </div>
    </div>

    <!-- ENDFIELD OPERATOR FILE MODAL -->
    <div class="modal-overlay" id="profileModal">
        <div class="operator-file" id="opFileCont">
            <div class="op-back" onclick="document.getElementById('profileModal').style.display='none'">&#8592;</div>

            <div class="op-left">
                <img id="pAvatar" class="op-avatar" src="">
                <div class="op-name-plate">
                    <div class="op-name" id="pName">USERNAME</div>
                    <div class="op-stars" id="pStars"></div>
                </div>
            </div>

            <div class="op-right">
                <div class="op-tabs-header">
                    <div class="op-top-tab active" onclick="switchTab('file')">üìÅ Operator File</div>
                    <div class="op-top-tab" onclick="switchTab('personnel')">üìÅ Personnel Logs</div>
                    <div class="op-top-tab" onclick="switchTab('settings')" id="settingsTabBtn" style="display:none;">‚öôÔ∏è
                        Settings</div>
                </div>

                <div class="op-content-area">
                    <!-- Tab: File Info -->
                    <div id="tab-file" class="tp active">
                        <!-- Basic Info Folder -->
                        <div class="op-folder">
                            <div class="op-folder-header" id="pHexId">10_000000</div>
                            <div class="op-folder-title">| BASIC INFO</div>
                            <div class="op-folder-body">
                                <div class="tech-grid">
                                    <div><strong>CODENAME:</strong> <span id="pCodename">Endministrator</span></div>
                                    <div><strong>CLEARANCE:</strong> <span id="pClearance">Lvl 1</span></div>
                                    <div><strong>AFFILIATION:</strong> Endfield Industries</div>
                                    <div><strong>ID HASH:</strong> <span id="pId">0000</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- HR Summary Folder -->
                        <div class="op-folder" style="margin-top: 20px;">
                            <div class="op-folder-header">HR_EVAL_012</div>
                            <div class="op-folder-title">| HUMAN RESOURCES SUMMARY</div>
                            <div class="op-folder-body" style="padding:0;">
                                <textarea id="pDesc" class="op-input" style="border:none; margin:0;"
                                    placeholder="No records found in database."></textarea>
                                <div style="padding: 10px 20px; background: rgba(0,0,0,0.2);">
                                    <button id="pSave" class="btn primary" style="display:none;"
                                        onclick="saveDesc()">UPDATE RECORD</button>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Logs -->
                        <div class="op-folder" style="margin-top: 20px;">
                            <div class="op-folder-header">SYS_PERF_METRICS</div>
                            <div class="op-folder-title">| ABILITY ASSESSMENT</div>
                            <div class="op-folder-body"
                                style="display: flex; justify-content: space-around; text-align: center;">
                                <div>
                                    <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);" id="pUp">0
                                    </div>
                                    <div style="font-family: var(--tech-font); font-size: 0.8rem;">TRANSMISSION UPLOADS
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);"
                                        id="pVote">0</div>
                                    <div style="font-family: var(--tech-font); font-size: 0.8rem;">COMBAT REPUTATION
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Personnel -->
                    <div id="tab-personnel" class="tp" style="display:none;">
                        <div class="op-folder">
                            <div class="op-folder-header">MUTUAL_PERSONNEL</div>
                            <div class="op-folder-title">| COOPERATION DIRECTORY</div>
                            <div class="op-folder-body">
                                <div id="pFriends"
                                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                    <!-- Populated via JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab: Settings (Only for self) -->
                    <div id="tab-settings" class="tp" style="display:none;">
                        <div class="op-folder">
                            <div class="op-folder-header">SYS_CONFIG</div>
                            <div class="op-folder-title">| AVATAR UPSCALER (AI)</div>
                            <div class="op-folder-body">
                                <p style="margin-top:0; font-size:0.85rem;">Enhance your Discord profile picture using
                                    local Neural Networks.<br>This will process locally and swap your display.</p>

                                <div class="tech-grid" style="margin-bottom:15px;">
                                    <div>
                                        <strong>AI MODEL:</strong><br>
                                        <select id="upModel" class="op-input"
                                            style="min-height:40px; padding:5px 10px; margin-top:5px;">
                                            <option value="waifu2x">Waifu2x (Fast, Anime)</option>
                                            <option value="realesrgan">Real-ESRGAN (Slower, High Detail)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <strong>MULTIPLIER:</strong><br>
                                        <select id="upScale" class="op-input"
                                            style="min-height:40px; padding:5px 10px; margin-top:5px;">
                                            <option value="2">2x (Recommended)</option>
                                            <option value="4">4x (Max)</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="display:flex; gap:10px;">
                                    <button class="btn primary" id="btnUpscale" style="flex:1; justify-content:center;"
                                        onclick="executeUpscale()">ENHANCE AVATAR</button>
                                    <button class="btn" style="border-color:#E57373; color:#E57373;"
                                        onclick="revertAvatar()">REVERT</button>
                                </div>
                            </div>
                        </div>

                        <!-- Badge Studio -->
                        <div class="op-folder" id="badgeStudioFol" style="margin-top:20px; display:none;">
                            <div class="op-folder-header">BADGE_SYS_DEF</div>
                            <div class="op-folder-title">| MERIT BADGE STUDIO</div>
                            <div class="op-folder-body">
                                <p style="margin-top:0; font-size:0.85rem;">Define custom rules for automated profile
                                    awards.</p>
                                <div id="badgeRulesList"
                                    style="margin-bottom:15px; max-height:150px; overflow-y:auto; border:1px dashed var(--border); padding:5px;">
                                </div>

                                <div class="tech-grid" style="margin-bottom:10px;">
                                    <div>
                                        <strong>BADGE NAME:</strong>
                                        <input type="text" id="bNameIn" class="op-input" style="padding:5px;"
                                            placeholder="e.g. Veteran">
                                    </div>
                                    <div>
                                        <strong>ICON (EMOJI):</strong>
                                        <select id="bIconIn" class="op-input" style="padding:5px; font-size:1.2rem;">
                                            <option value="‚≠ê">‚≠ê</option>
                                            <option value="üî•">üî•</option>
                                            <option value="üí†">üí†</option>
                                            <option value="üì¶">üì¶</option>
                                            <option value="üßê">üßê</option>
                                            <option value="üèÜ">üèÜ</option>
                                            <option value="üíé">üíé</option>
                                            <option value="üõ°Ô∏è">üõ°Ô∏è</option>
                                            <option value="‚ö°">‚ö°</option>
                                            <option value="üëë">üëë</option>
                                            <option value="üé¨">üé¨</option>
                                            <option value="üé®">üé®</option>
                                            <option value="üöÄ">üöÄ</option>
                                            <option value="üí°">üí°</option>
                                            <option value="üß©">üß©</option>
                                            <option value="üïπÔ∏è">üïπÔ∏è</option>
                                            <option value="üé§">üé§</option>
                                            <option value="üéß">üéß</option>
                                            <option value="üíÄ">üíÄ</option>
                                            <option value="üíØ">üíØ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <strong>CONDITION TARGET:</strong>
                                        <select id="bTypeIn" class="op-input" style="padding:5px;">
                                            <option value="upload">Uploads</option>
                                            <option value="vote">Votes Given</option>
                                            <option value="manual">Manual Assignment Only</option>
                                        </select>
                                    </div>
                                    <div>
                                        <strong>VAR VALUE (X):</strong>
                                        <input type="number" id="bValIn" class="op-input" style="padding:5px;"
                                            value="10">
                                    </div>
                                </div>
                                <label
                                    style="display:block; margin-bottom: 15px; font-family:var(--tech-font); font-size:0.8rem; cursor:pointer;">
                                    <input type="checkbox" id="bCardVisIn"> Show on Media Thumbnail Cards (Global
                                    Visibility)
                                </label>
                                <button class="btn primary" style="width:100%; justify-content:center;"
                                    onclick="createBadgeRule()">DEPLOY NEW BADGE</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regularization Modal for missing tags -->
    <div class="modal-overlay" id="regularizeModal">
        <div class="dossier-panel" style="max-height: 400px;">
            <div class="dossier-head">
                <div class="dossier-title">> REGULARIZE TAGS</div>
                <button class="post-btn-small" onclick="closeRegularize()">X</button>
            </div>
            <div class="dossier-body">
                <p>FILE: <span id="regFilename" style="color:var(--primary);"></span></p>
                <p style="color:var(--text-sec); font-size:0.85rem;">Assign between 1 and 5 tags to properly catalog
                    this item in the database. Missing tags cause a Level 2 Orange Warning.</p>
                <div>
                    <strong>TAGS (comma separated):</strong>
                    <input type="text" id="regTags" class="op-input" placeholder="e.g. cat, meme, jump" maxlength="60">
                </div>
                <button class="btn primary" style="width:100%; margin-top:15px; justify-content:center;"
                    onclick="saveRegularizedTags()">SAVE METADATA</button>
            </div>
        </div>
    </div>

    <!-- JS Scripts -->
    <script src="mpgif_reader.js"></script>
    <script src="mpgif_player.js"></script>
    <script>
        const API = { files: '/api/files', vote: '/api/vote', favorites: '/api/favorites', upload: '/api/upload', delete: '/api/delete', publish: '/api/publish', user: '/api/user', members: '/api/members', guild: '/api/guild/info', update_user: '/api/user/update', channels: '/api/channels', convert: '/api/convert', regularize: '/api/regularize', badges: '/api/badges/rules' };
        let state = { files: [], favorites: [], filter: false, category: '', currentPlayer: null, canManage: false };
        const p = new URLSearchParams(window.location.search);
        const userId = p.get('uid'); const username = p.get('user') || 'GUEST'; const guildId = p.get('gid');

        // Helper: Get Rarity Color Hex and Stars based on stats
        function getRarityData(dUser) {
            let stars = 4; let color = "var(--rarity-4)"; let label = "OPERATOR";
            if (dUser.is_admin) { stars = 6; color = "var(--rarity-6)"; label = "ADMIN"; }
            else if (dUser.is_mod) { stars = 5; color = "var(--rarity-5)"; label = "MODERATOR"; }
            else if (dUser.is_bot) { stars = 3; color = "var(--rarity-3)"; label = "SYSTEM BOT"; }
            else if (dUser.stats && dUser.stats.uploads > 5) { stars = 5; color = "var(--rarity-5)"; label = "SENIOR OPP"; }
            return { stars, color, label };
        }

        async function init() {
            document.getElementById('navUser').textContent = username;
            document.getElementById('navId').textContent = "ID: " + (userId ? userId.substring(0, 6) : "000");

            if (userId) {
                try {
                    const rUser = await fetch(`/api/user/${userId}`);
                    if (rUser.ok) {
                        const dUser = await rUser.json();
                        document.getElementById('navAvatar').src = dUser.avatar_url || `https://cdn.discordapp.com/embed/avatars/${userId % 5}.png`;
                        state.canManage = dUser.is_admin;

                        // Apply Rarity Border to Navbar Avatar
                        const r = getRarityData(dUser);
                        document.getElementById('navAvatarWrapper').style.borderColor = r.color;
                        document.getElementById('navAvatarWrapper').style.boxShadow = `0 0 15px ${r.color}`;
                    }
                } catch (e) { }
            }

            // Server Info Request
            if (guildId) {
                try {
                    const r = await fetch(API.guild + '?guild_id=' + guildId);
                    if (r.ok) {
                        const g = await r.json();
                        if (!g.error) {
                            document.getElementById('serverName').textContent = g.name.toUpperCase();
                            document.getElementById('serverBannerName').textContent = g.name.toUpperCase();
                            if (g.member_count) { document.getElementById('serverMembers').textContent = g.member_count; }
                            if (g.icon) {
                                document.getElementById('serverBanner').style.backgroundImage = `linear-gradient(45deg, rgba(255,213,79,0.2), transparent), url(${g.icon})`;
                                document.querySelector('.server-default-text').style.display = 'none';
                            }
                        }
                    }
                } catch (e) { }
                loadChannels();
            }

            await loadFiles();
            render();
            document.getElementById('searchInput').addEventListener('input', (e) => render(e.target.value));
            document.getElementById('pDesc').addEventListener('input', () => document.getElementById('pSave').style.display = 'block');
        }

        async function loadFiles() {
            try { const r = await fetch(API.files); state.files = await r.json(); } catch (e) { }
            if (userId) { try { const rf = await fetch(`${API.favorites}?user_id=${userId}`); const d = await rf.json(); state.favorites = d.favorites || []; } catch (e) { } }
        }

        function render(search = '') {
            const sh = document.getElementById('grid-shorts'); const vi = document.getElementById('grid-videos');
            sh.innerHTML = ''; vi.innerHTML = '';
            let list = state.files.filter(f => {
                const s = search.toLowerCase();
                let matchesSearch = false;
                if (f.name.toLowerCase().includes(s)) matchesSearch = true;

                let safeTags = Array.isArray(f.tags) ? f.tags : (typeof f.tags === 'string' ? [f.tags] : []);
                if (safeTags.some(t => typeof t === 'string' && t.toLowerCase().includes(s))) matchesSearch = true;

                if (!matchesSearch && s !== '') return false;

                // Category Filter
                if (state.category !== '') {
                    if (!safeTags.some(t => typeof t === 'string' && t.toLowerCase() === state.category.toLowerCase())) return false;
                }

                return true;
            });
            if (state.filter) list = list.filter(f => state.favorites.includes(f.name));

            list.forEach(f => {
                const card = document.createElement('div'); card.className = 'card';
                // Try database logic first. Default to Horizontal (vi) if metadata missing or 0
                let isShort = (f.height > 0 && f.width > 0) ? (f.height > f.width) : false;
                if (isShort) sh.appendChild(card); else vi.appendChild(card);

                const isFav = state.favorites.includes(f.name);

                let warningHtml = '';

                // Tags Setup
                let safeTags = [];
                if (Array.isArray(f.tags)) safeTags = f.tags;
                else if (typeof f.tags === 'string') safeTags = [f.tags];

                if (safeTags.length === 0 && state.canManage) {
                    // Orange Warning Level 2 for Missing Tags
                    warningHtml = `<div class="warning-badge warn-orange" title="Missing Tags - Click to Regularize" onclick="openRegularize('${f.name}')">!</div>`;
                }

                card.innerHTML = `
                 ${warningHtml}
                 <!-- Canvas acting as publish trigger -->
                 <div class="media-box" onclick="publish('${f.name}')" title="Click to Post"></div>
                 
                 <div class="card-body">
                     <div class="card-actions">
                         <div class="filename" title="${f.name}">${f.name}</div>
                     </div>
                     <div class="card-actions" style="margin-top:10px;">
                         <div style="display:flex; align-items:center; gap:5px; background:rgba(0,0,0,0.3); border-radius:15px; padding:2px 5px;">
                             <button class="icon-btn icon-btn-vote" onclick="vote('${f.name}','down')">‚ñº</button>
                             <span style="font-weight:bold; font-size:0.8rem; margin:auto;">${f.score || 0}</span>
                             <button class="icon-btn icon-btn-vote" onclick="vote('${f.name}','up')">‚ñ≤</button>
                         </div>
                         <div style="display:flex; gap:10px;">
                            ${state.canManage ? `<button class="icon-btn" style="color:#E57373;" onclick="del('${f.name}')">üóë</button>` : ''}
                            <button class="icon-btn" onclick="share('${f.name}')">üîó</button>
                            <button class="icon-btn ${isFav ? 'active' : ''}" onclick="fav('${f.name}')">‚òÖ</button>
                         </div>
                     </div>
                 </div>`;

                const box = card.querySelector('.media-box');
                const cvs = document.createElement('canvas'); box.appendChild(cvs);
                const pl = new MPGIFPlayer(cvs);

                box.onmouseenter = () => {
                    if (state.currentPlayer && state.currentPlayer !== pl) state.currentPlayer.stop();
                    state.currentPlayer = pl;
                    pl.load(`/files/${f.name}`).then(() => { pl.play().catch(e => { }); });
                };
                box.onmouseleave = () => { pl.stop(); if (state.currentPlayer === pl) state.currentPlayer = null; };

                pl.load(`/files/${f.name}`).then(() => {
                    // Check actual loaded data to correct missing DB metadata
                    if (pl.mpgif && pl.mpgif.height > 0 && pl.mpgif.width > 0) {
                        const actualShort = pl.mpgif.height > pl.mpgif.width;
                        if (actualShort && !isShort) {
                            sh.appendChild(card); // Move to short list natively
                            isShort = true;
                        } else if (!actualShort && isShort) {
                            vi.appendChild(card); // Move to video list natively
                            isShort = false;
                        }
                    }
                }).catch(err => {
                    console.warn(`File ${f.name} is corrupted and will be hidden from UI.`, err);
                    if (state.canManage) {
                        // Level 3 Red Warning for corrupted files or 404
                        box.innerHTML = `<div class="warning-badge warn-red" title="Broken File (404/Corrupted) - Needs Admin attention" style="position:relative; margin: 20px auto;">!</div>`;
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
        }

        window.setCategory = (cat) => {
            state.category = cat;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render(document.getElementById('searchInput').value);
        };

        window.openLeaderboard = () => {
            document.getElementById('leaderboardModal').style.display = 'flex';
            loadLeaderboard('score');
        };

        window.loadLeaderboard = async (sortBy) => {
            const list = document.getElementById('leaderboardList');
            document.getElementById('sortScoreBtn').className = sortBy === 'score' ? 'btn primary' : 'btn';
            document.getElementById('sortUploadsBtn').className = sortBy === 'uploads' ? 'btn primary' : 'btn';

            list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-sec); font-family:var(--tech-font);">FETCHING INTEL...</div>`;

            if (!guildId) {
                list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-sec); font-family:var(--tech-font);">ERROR: DISCORD CONNECTION OFFLINE</div>`;
                return;
            }

            try {
                const r = await fetch(API.members + '?guild_id=' + guildId);
                let members = await r.json();

                if (members.error) {
                    list.innerHTML = `<div style="text-align:center; padding:30px; color:#ef5350; font-family:var(--tech-font);">${members.error}</div>`;
                    return;
                }

                // Exclude members with 0 stats
                members = members.filter(m => m.stats && (m.stats.votes > 0 || m.stats.uploads > 0));

                if (sortBy === 'score') {
                    members.sort((a, b) => b.stats.votes - a.stats.votes);
                } else if (sortBy === 'uploads') {
                    members.sort((a, b) => b.stats.uploads - a.stats.uploads);
                }

                list.innerHTML = '';
                if (members.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-sec); font-family:var(--tech-font);">NO DATA AVAILABLE</div>`;
                    return;
                }

                members.forEach((m, idx) => {
                    const row = document.createElement('div');
                    row.className = 'lb-row';

                    let bgCol = "transparent";
                    if (idx === 0) bgCol = "rgba(255, 215, 0, 0.1)"; // Gold
                    else if (idx === 1) bgCol = "rgba(192, 192, 192, 0.1)"; // Silver
                    else if (idx === 2) bgCol = "rgba(205, 127, 50, 0.1)"; // Bronze

                    row.style.background = bgCol;

                    const avatarSrc = m.avatar || `https://cdn.discordapp.com/embed/avatars/${m.id % 5}.png`;
                    const rarityData = getRarityData(m);

                    let badgesHtml = '';
                    if (m.badges && m.badges.length > 0) {
                        badgesHtml = `<div style="display:flex; gap:2px; margin-top:2px;">` +
                            m.badges.map(icon => `<span style="font-size:0.8rem; background:rgba(0,0,0,0.5); padding:2px; border-radius:3px; border:1px solid var(--border);">${icon}</span>`).join('') +
                            `</div>`;
                    }

                    row.innerHTML = `
                        <div class="lb-rank">#${idx + 1}</div>
                        <div class="lb-userinfo" onclick="openProfile('${m.id}')" style="cursor:pointer;">
                            <img class="lb-avatar" src="${avatarSrc}" style="border-color:${rarityData.color}">
                            <div>
                                <div style="font-weight:bold; color:var(--text-main);">${m.global_name || m.username}</div>
                                <div style="font-size:0.75rem; color:var(--text-sec); font-family:var(--tech-font);">${rarityData.label}</div>
                                ${badgesHtml}
                            </div>
                        </div>
                        <div class="lb-stats">
                            <span style="color:var(--primary); font-size:1.1rem; font-weight:bold;">${sortBy === 'score' ? m.stats.votes : m.stats.uploads}</span><br>
                            ${sortBy === 'score' ? 'REPUTATION' : 'FILES UPLOADED'}
                        </div>
                    `;
                    list.appendChild(row);
                });

            } catch (err) {
                console.error("Leaderboard error:", err);
                list.innerHTML = `<div style="text-align:center; padding:30px; color:#ef5350; font-family:var(--tech-font);">SYSTEM FAILURE</div>`;
            }
        };

        window.openProfile = async (tid) => {
            if (!tid) return;

            const cont = document.getElementById('opFileCont');
            // Re-trigger animation
            cont.style.animation = 'none';
            cont.offsetHeight; /* trigger reflow */
            cont.style.animation = null;

            document.getElementById('profileModal').style.display = 'flex';

            try {
                const r = await fetch(`/api/user/${tid}`);
                const d = await r.json();

                const rty = getRarityData(d);
                cont.style.setProperty('--op-border-color', rty.color);
                cont.style.boxShadow = `0 0 40px ${rty.color}80, inset 0 0 60px ${rty.color}40`;

                const defaultAvatar = d.avatar_url || `https://cdn.discordapp.com/embed/avatars/${tid % 5}.png`;
                const pAvatar = document.getElementById('pAvatar');
                pAvatar.src = defaultAvatar;

                // Silently auto-upscale in the background for better presentation
                if (defaultAvatar) {
                    baseAvatarUrl = defaultAvatar; // Ensure Revert knows the original URL
                    fetch('/api/upscale_avatar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: tid,
                            avatar_url: defaultAvatar,
                            model: 'waifu2x',
                            scale: 2
                        })
                    }).then(res => res.json()).then(resData => {
                        if (resData.image_b64) {
                            // Only swap if we are still viewing the same user profile!
                            if (document.getElementById('pId').textContent == tid) {
                                pAvatar.src = resData.image_b64;
                            }
                        }
                    }).catch(err => console.log("Silent auto-upscale failed", err));
                }

                document.getElementById('pName').textContent = d.username;
                document.getElementById('pId').textContent = tid;
                document.getElementById('pCodename').textContent = d.username;

                // Hex ID fake gen based on ID
                document.getElementById('pHexId').textContent = "OP_" + tid.substring(0, 6);

                const s = document.getElementById('pStars'); s.innerHTML = '';
                for (let i = 0; i < rty.stars; i++) { const im = document.createElement('img'); im.src = 'stars.png'; s.appendChild(im); }

                document.getElementById('pClearance').textContent = rty.label;
                document.getElementById('pUp').textContent = d.stats.uploads || 0;
                document.getElementById('pVote').textContent = d.stats.votes || 0;

                const descBox = document.getElementById('pDesc');
                descBox.value = d.description || "";
                descBox.readOnly = (tid !== userId);
                document.getElementById('pSave').style.display = 'none';

                if (tid === userId && guildId) loadMembers();

                const settingsBtn = document.getElementById('settingsTabBtn');
                if (settingsBtn) {
                    if (tid === userId) settingsBtn.style.display = 'flex';
                    else settingsBtn.style.display = 'none';
                }

                switchTab('file');
            } catch (e) { }
        }

        async function loadMembers() {
            const c = document.getElementById('pFriends'); c.innerHTML = 'Accessing Personnel DB...';
            try {
                const r = await fetch(`api/members?guild_id=${guildId}`);
                const m = await r.json();
                c.innerHTML = '';
                m.forEach(u => {
                    const rty = getRarityData({ is_admin: u.is_admin, is_mod: u.is_mod, is_bot: u.is_bot, stats: u.stats || { uploads: 0 } }); // Real stats from API
                    const d = document.createElement('div');
                    d.style.cssText = `background:rgba(0,0,0,0.2); border:1px solid ${rty.color}; box-shadow: 0 0 10px ${rty.color}40; padding:10px; display:flex; gap:10px; cursor:pointer;`;
                    d.onclick = () => openProfile(u.id);
                    d.innerHTML = `<img src="${u.avatar || `https://cdn.discordapp.com/embed/avatars/${u.id % 5}.png`}" style="width:35px; height:35px; border-radius:4px; object-fit:cover;"><div><div style="font-weight:bold; font-size:0.85rem; color:#fff;">${u.global_name || u.username}</div><div style="font-size:0.7rem; color:var(--text-sec); font-family:var(--tech-font);">${rty.label}</div></div>`;
                    c.appendChild(d);
                });
            } catch { c.innerHTML = 'Error retrieving personnel.'; }
        }

        window.saveDesc = async () => {
            const txt = document.getElementById('pDesc').value;
            try {
                await fetch(API.update_user, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, description: txt }) });
                document.getElementById('pSave').style.display = 'none';
                showToast("ARCHIVE RECORD UPDATED");
            } catch (e) { showToast("UPDATE FAILED"); }
        }

        window.loadBadgeRules = async () => {
            const list = document.getElementById('badgeRulesList');
            if (!list || list.style.display === 'none') return;
            try {
                const r = await fetch(API.badges);
                const rules = await r.json();
                list.innerHTML = '';
                if (rules.length === 0) list.innerHTML = '<div style="color:var(--text-sec); font-family:var(--ui-font); padding:10px;">No rules defined.</div>';
                rules.forEach(rl => {
                    const idiv = document.createElement('div');
                    idiv.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px solid rgba(255,255,255,0.1); font-family:var(--tech-font); font-size:0.8rem;";
                    idiv.innerHTML = `<div>${rl.icon} <strong>${rl.name}</strong> [${rl.condition_type} >= ${rl.condition_value}] ${rl.show_on_card ? '(Card Vis)' : ''}</div>
                    <button class="post-btn-small" style="color:#E57373; border-color:#E57373; padding:2px 5px;" onclick="deleteBadgeRule('${rl.id}')">X</button>`;
                    list.appendChild(idiv);
                });
            } catch (e) { }
        }

        window.createBadgeRule = async () => {
            const nm = document.getElementById('bNameIn').value;
            if (!nm) return showToast("NAME REQUIRED");
            const data = {
                user_id: userId,
                name: nm,
                icon: document.getElementById('bIconIn').value,
                condition_type: document.getElementById('bTypeIn').value,
                condition_value: document.getElementById('bValIn').value,
                show_on_card: document.getElementById('bCardVisIn').checked
            };
            try {
                const r = await fetch(API.badges, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (r.ok) { showToast("RULE DEPLOYED"); loadBadgeRules(); }
                else showToast("DEPLOYMENT FAILED");
            } catch (e) { showToast("SERVER ERROR"); }
        }

        window.deleteBadgeRule = async (id) => {
            if (!confirm("Erase rule permanently?")) return;
            try {
                const r = await fetch(API.badges, { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, rule_id: id }) });
                if (r.ok) { showToast("RULE ERASED"); loadBadgeRules(); }
            } catch (e) { }
        }

        window.toggleServerPanel = () => { document.getElementById('serverPanel').classList.toggle('visible'); document.getElementById('serverTrigger').classList.toggle('active'); }
        window.toggleTheme = () => { document.body.classList.toggle('light-theme'); }
        window.toggleFavs = () => { state.filter = !state.filter; render(); document.getElementById('favBtn').classList.toggle('primary'); }
        window.switchTab = (t) => {
            document.querySelectorAll('.tp').forEach(e => e.style.display = 'none');
            document.getElementById('tab-' + t).style.display = 'block';
            document.querySelectorAll('.op-top-tab').forEach(e => e.classList.remove('active'));
            if (t === 'file') document.querySelectorAll('.op-top-tab')[0].classList.add('active');
            else if (t === 'personnel') document.querySelectorAll('.op-top-tab')[1].classList.add('active');
            else if (t === 'settings') {
                document.querySelectorAll('.op-top-tab')[2].classList.add('active');
                if (state.canManage) {
                    const bs = document.getElementById('badgeStudioFol');
                    if (bs) { bs.style.display = 'block'; loadBadgeRules(); }
                }
            }
        }

        window.share = async (f) => {
            const url = window.location.origin + '/v/' + f;
            try { await navigator.clipboard.writeText(url); showToast("URL COPIED TO CLIPBOARD"); }
            catch (err) { showToast("FAILED TO COPY URL"); }
        }

        async function vote(n, t) { if (!userId) return showToast("LOGIN REQ"); await fetch(API.vote, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, filename: n, type: t }) }); loadFiles().then(render); }
        async function fav(n) { if (!userId) return showToast("LOGIN REQ"); const r = await fetch(API.favorites, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_id: userId, filename: n, action: state.favorites.includes(n) ? 'remove' : 'add' }) }); if (r.ok) { const d = await r.json(); state.favorites = d.favorites; render(); } }
        async function del(n) { if (!userId || !state.canManage) return; if (confirm("DELETE PURGE: " + n + "?")) { await fetch(API.delete, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: n, user_id: userId }) }); loadFiles().then(render); } }
        async function publish(f) { if (!userId) return showToast("LOGIN REQ"); showToast("TRANSMITTING..."); await fetch(API.publish, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filename: f, channel_id: document.getElementById('channelSelect').value, user_id: userId }) }); showToast("TRANSMISSION CLEAR"); }
        let pendingUploads = [];

        window.handleFileSelect = (e) => {
            const files = e.target.files;
            for (let i = 0; i < files.length; i++) {
                if (!pendingUploads.some(f => f.name === files[i].name && f.size === files[i].size)) {
                    pendingUploads.push(files[i]);
                }
            }
            renderUploadList();
            e.target.value = '';
        }

        window.removeUpload = (idx) => {
            pendingUploads.splice(idx, 1);
            renderUploadList();
        }

        function renderUploadList() {
            const listCont = document.getElementById('uploadList');
            const filesCont = document.getElementById('uploadFilesCont');
            const btn = document.getElementById('doUploadBtn');
            const drop = document.getElementById('dropZ');

            filesCont.innerHTML = '';
            if (pendingUploads.length > 0) {
                listCont.style.display = 'block';
                btn.style.display = 'flex';
                drop.innerHTML = `[ ${pendingUploads.length} FILE(S) SELECTED - ADD MORE? ]`;
                pendingUploads.forEach((f, idx) => {
                    const item = document.createElement('div'); item.className = 'c-item';
                    item.innerHTML = `<span><span style="color:var(--primary);">FILE:</span> ${f.name}</span> 
                        <button class="post-btn-small" style="padding:2px 8px; color:#E57373; border-color:#E57373;" onclick="removeUpload(${idx})">X</button>`;
                    filesCont.appendChild(item);
                });
            } else {
                listCont.style.display = 'none';
                btn.style.display = 'none';
                drop.innerHTML = '[ DRAG & DROP OR CLICK TO UPLOAD ]';
            }
        }

        async function doUpload() {
            if (pendingUploads.length === 0) return;
            const btn = document.getElementById('doUploadBtn');
            btn.style.pointerEvents = 'none';
            document.getElementById('dropZ').textContent = "TRANSMITTING DATA...";

            let totalBytes = pendingUploads.reduce((acc, f) => acc + f.size, 0);
            let loadedBytes = new Array(pendingUploads.length).fill(0);
            const nm = document.getElementById('upName').value;
            let hasError = false;

            const uploadPromises = pendingUploads.map((file, i) => {
                return new Promise((resolve, reject) => {
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('user_id', userId);
                    if (nm && pendingUploads.length === 1) fd.append('custom_name', nm);
                    const tagsInput = document.getElementById('upTags');
                    if (tagsInput && tagsInput.value) {
                        fd.append('tags', tagsInput.value);
                    }

                    const xhr = new XMLHttpRequest();
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            loadedBytes[i] = e.loaded;
                            const totalLoaded = loadedBytes.reduce((a, b) => a + b, 0);
                            const percent = Math.round((totalLoaded / totalBytes) * 100);
                            btn.textContent = `UPLOADING... [${percent}%]`;
                            document.getElementById('dropZ').textContent = `TRANSMITTING DATA: ${percent}%`;
                        }
                    });

                    xhr.addEventListener('load', () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve();
                        } else {
                            try {
                                const err = JSON.parse(xhr.responseText);
                                reject(new Error(err.error || "Upload failed"));
                            } catch (ex) { reject(new Error("Upload failed")); }
                        }
                    });

                    xhr.addEventListener('error', () => reject(new Error("Network Error")));
                    xhr.addEventListener('abort', () => reject(new Error("Upload Aborted")));

                    xhr.open('POST', API.upload);
                    xhr.send(fd);
                });
            });

            try {
                await Promise.all(uploadPromises);
            } catch (e) {
                console.error("Upload failed", e);
                showToast("ERROR: " + e.message);
                hasError = true;
            }

            btn.textContent = "INITIATE UPLOAD"; btn.style.pointerEvents = 'auto';
            document.getElementById('dropZ').textContent = "[ DRAG & DROP OR CLICK TO UPLOAD ]";

            if (!hasError) {
                document.getElementById('uploadModal').style.display = 'none';
                document.getElementById('upName').value = '';
                document.getElementById('upTags').value = '';
                pendingUploads = [];
                renderUploadList();
                showToast("FILES UPLOADED");
                loadFiles().then(render);
            }
        }

        // --- TAG REGULARIZATION MODAL ---
        let currentRegularizingFile = null;
        window.openRegularize = (filename) => {
            currentRegularizingFile = filename;
            const fileData = state.files.find(f => f.name === filename);
            const currentTags = fileData && fileData.tags ? fileData.tags.join(', ') : '';

            document.getElementById('regTags').value = currentTags;
            document.getElementById('regFilename').textContent = filename;
            document.getElementById('regularizeModal').style.display = 'flex';
        };

        window.closeRegularize = () => {
            document.getElementById('regularizeModal').style.display = 'none';
            currentRegularizingFile = null;
        };

        window.saveRegularizedTags = async () => {
            if (!currentRegularizingFile) return;
            const rawTags = document.getElementById('regTags').value.split(',').map(t => t.trim()).filter(t => t);

            if (rawTags.length < 1) { showToast("AT LEAST 1 TAG REQUIRED"); return; }
            if (rawTags.length > 5) { showToast("MAX 5 TAGS ALLOWED"); return; }

            try {
                const r = await fetch('/api/tags/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: currentRegularizingFile, user_id: userId, tags: rawTags })
                });
                if (r.ok) {
                    showToast("TAGS CONFIGURED");
                    closeRegularize();
                    loadFiles().then(render);
                } else {
                    const err = await r.json();
                    showToast("UPDATE FAILED: " + (err.error || "Unknown"));
                }
            } catch (e) {
                showToast("NETWORK ERROR");
            }
        };
        async function doConvert() {
            const input = document.getElementById('cIn');
            const files = input.files;
            if (files.length === 0) return;

            const btn = document.getElementById('convBtn');
            btn.style.pointerEvents = 'none';
            btn.textContent = `UPLOADING RAW FILES... [0%]`;

            const autoUp = document.getElementById('cAutoUpload').checked;
            const cStart = document.getElementById('cStart').value;
            const cEnd = document.getElementById('cEnd').value;

            const taskId = "task_" + Math.random().toString(36).substr(2, 9);
            const fd = new FormData();
            for (let i = 0; i < files.length; i++) fd.append('files', files[i]);
            if (autoUp) { fd.append('auto_upload', 'true'); fd.append('user_id', userId); }
            if (cStart) fd.append('start_time', cStart);
            if (cEnd) fd.append('end_time', cEnd);
            fd.append('task_id', taskId);

            let pollTimer = null;
            let cLog = document.getElementById('cLog');
            document.getElementById('cResults').style.display = 'block';
            cLog.innerHTML = '<div style="color:var(--primary); font-family:var(--tech-font);">[UPLOADING RAW FILES TO SERVER...]</div>';

            const startPolling = () => {
                pollTimer = setInterval(async () => {
                    try {
                        const r = await fetch('/api/progress?task_id=' + taskId);
                        if (r.ok) {
                            const pData = await r.json();
                            if (pData.status === "converting") {
                                btn.textContent = `CONVERTING... [${pData.percent}%]`;
                                cLog.innerHTML = `<div style="color:var(--primary); font-family:var(--tech-font);">[PROCESSING: ${pData.current_file}]</div>
                                  <div style="width:100%; background:var(--surface); height:5px; margin-top:5px;"><div style="width:${pData.percent}%; background:var(--primary); height:100%;"></div></div>`;
                            }
                        }
                    } catch (e) { }
                }, 1000);
            };

            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    btn.textContent = `UPLOADING RAW FILES... [${percent}%]`;
                }
            });

            xhr.addEventListener('readystatechange', () => {
                if (xhr.readyState === 2 && !pollTimer) {
                    startPolling();
                }
            });

            xhr.addEventListener('load', async () => {
                if (pollTimer) clearInterval(pollTimer);
                btn.textContent = "CONVERT FORMAT";
                btn.style.pointerEvents = 'auto';

                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const d = JSON.parse(xhr.responseText);
                        if (autoUp) {
                            cLog.innerHTML += `<div style="color:#81D4FA; margin-top:5px;">[UPLOADED AND CATALOGUED]</div>`;
                            document.getElementById('cZip').style.display = 'none';
                            loadFiles().then(render);
                            showToast("CONVERT & UPLOAD COMPLETE");
                        } else {
                            cLog.innerHTML = '';
                            d.files.forEach(f => {
                                const item = document.createElement('div'); item.className = 'c-item';
                                item.innerHTML = `<span><span style="color:var(--primary);">FILE:</span> ${f}</span> 
                                    <a href="/api/download_converted/${d.batch_id}/${f}">
                                    <button class="post-btn-small" style="padding:2px 8px;">DL</button></a>`;
                                cLog.appendChild(item);
                            });
                            document.getElementById('cZip').href = d.zip_url;
                            document.getElementById('cZip').style.display = 'block';
                            showToast("CONVERSION COMPLETE");
                        }
                    } catch (ex) { showToast("ERROR PARSING RESPONSE"); }
                } else {
                    showToast("ERROR OCURRED");
                    try { const d = JSON.parse(xhr.responseText); if (d.error) showToast(d.error); } catch (e) { }
                }
            });

            xhr.addEventListener('error', () => {
                if (pollTimer) clearInterval(pollTimer);
                showToast("CONVERSION FAILED");
                btn.textContent = "CONVERT FORMAT";
                btn.style.pointerEvents = 'auto';
            });
            xhr.addEventListener('abort', () => {
                if (pollTimer) clearInterval(pollTimer);
                btn.textContent = "CONVERT FORMAT";
                btn.style.pointerEvents = 'auto';
            });

            xhr.open('POST', API.convert);
            xhr.send(fd);
        }

        window.clearConversions = () => {
            document.getElementById('cLog').innerHTML = '';
            document.getElementById('cResults').style.display = 'none';
            document.getElementById('cZip').href = '#';
        };

        window.closeConverter = () => {
            document.getElementById('converterModal').style.display = 'none';
            clearConversions();
        };

        // --- UPSCALER LOGIC ---
        let baseAvatarUrl = '';

        window.executeUpscale = async () => {
            const btn = document.getElementById('btnUpscale');
            const pAvatar = document.getElementById('pAvatar');

            // Save the base avatar purely for reversion purposes if not already saved
            if (!baseAvatarUrl) baseAvatarUrl = pAvatar.src;

            // Can't upscale base64 again, must use base
            const targetUrl = baseAvatarUrl;

            const model = document.getElementById('upModel').value;
            const scale = document.getElementById('upScale').value;

            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';

            // ETA guessing: Waifu2x 2x (~5s), 4x (~15s) | ESRGAN 2x (~15s), 4x (~45s)
            let estimatedMaxSec = 5;
            if (model === 'waifu2x' && scale == 4) estimatedMaxSec = 15;
            if (model === 'realesrgan' && scale == 2) estimatedMaxSec = 15;
            if (model === 'realesrgan' && scale == 4) estimatedMaxSec = 45;

            let elapsedSec = 0;
            const formatT = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${Math.floor(s % 60).toString().padStart(2, '0')}`;

            btn.textContent = `UPSCALING... [00:00 / ~${formatT(estimatedMaxSec)} MAX]`;
            let timerInt = setInterval(() => {
                elapsedSec++;
                btn.textContent = `UPSCALING... [${formatT(elapsedSec)} / ~${formatT(estimatedMaxSec)} MAX]`;
            }, 1000);

            try {
                const req = await fetch('/api/upscale_avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        avatar_url: targetUrl,
                        model: model,
                        scale: scale
                    })
                });

                const res = await req.json();

                if (req.ok && res.image_b64) {
                    pAvatar.src = res.image_b64;
                    showToast("AVATAR ENHANCED");
                } else {
                    showToast("UPSCALER FAILED: " + (res.error || "Unknown Error"));
                }
            } catch (err) {
                console.error("Upscale attempt failed:", err);
                showToast("UPSCALER COMMUNICATION ERROR");
            }

            clearInterval(timerInt);
            btn.textContent = "ENHANCE AVATAR";
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        };

        window.revertAvatar = () => {
            if (baseAvatarUrl) {
                document.getElementById('pAvatar').src = baseAvatarUrl;
                showToast("REVERTED TO BASE RESOLUTION");
            } else {
                showToast("ALREADY USING ORIGINAL AVATAR");
            }
        };

        async function loadChannels() {
            try {
                const r = await fetch(API.channels + `?guild_id=${guildId}`);
                const d = await r.json();
                const s = document.getElementById('channelSelect');
                s.innerHTML = '';
                if (!d || d.length === 0) { s.innerHTML = '<option>NO CHANNELS</option>'; return; }
                d.forEach(x => {
                    const o = document.createElement('option'); o.value = x.id; o.textContent = '#' + x.name; s.appendChild(o);
                });
            } catch (e) {
                document.getElementById('channelSelect').innerHTML = '<option>ERROR</option>';
            }
        }
        function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }

        window.onclick = (e) => {
            if (!e.target.closest('.server-trigger')) {
                const p = document.getElementById('serverPanel');
                if (p) p.classList.remove('visible');
                const t = document.getElementById('serverTrigger');
                if (t) t.classList.remove('active');
            }
        };
        init();
    </script>

    <!-- ___ TUTORIAL OVERLAY & DIALOG ___ -->
    <div id="tutorial-overlay">
        <div id="tutorial-hole"></div>
    </div>

    <div id="tut-chibi-floating">
        <img id="tut-chibi" src="">
    </div>

    <div id="ember-dialog">
        <div class="dialog-content">
            <div>
                <div class="dialog-header">Ember - Terminal Guide</div>
                <div class="dialog-text" id="tut-text"></div>
            </div>
            <div class="dialog-controls">
                <button class="btn-tut" id="tut-btn-skip" onclick="skipTutorial()">SKIP TUTORIAL</button>
                <button class="btn-tut" id="tut-btn-prev" onclick="tutPrev()">‚óÄ BACK</button>
                <button class="btn-tut" id="tut-btn-next" onclick="tutNext()">NEXT ‚ñ∂</button>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MAIN SCRIPT -->
    <script>
        let tutSteps = [];
        let currTut = 0;
        let tutClickHandler = null;

        const chibiPath = "chibi/";

        function getTutorialStrings() {
            let tone = "casual";
            if (typeof dUser !== 'undefined' && dUser.is_admin) tone = "admin";
            else if (typeof dUser !== 'undefined') {
                const stats = dUser.stats || { uploads: 0 };
                let stars = 1;
                if (stats.uploads >= 50) stars = 5;
                if (stats.uploads >= 20 && stats.uploads < 50) stars = 4;
                if (stars >= 5) tone = "veteran";
            }

            const text = {
                admin: [
                    "Bonjour, Administrateur. Le Terminal Visuel est pr√™t. Laissez-moi vous guider √† travers les r√©centes modifications.",
                    "Voici votre acc√®s au profil directeur. Cliquez dessus pour v√©rifier vos accr√©ditations.",
                    "Tr√®s bien. Voici le r√©sum√© de vos classifications ainsi que le trombinoscope du personnel. Cliquez sur NEXT.",
                    "Maintenant, observez ce transmetteur LINK. Cliquez dessus pour param√©trer le flux r√©seau.",
                    "Parfait. Utilisez ce panneau pour surveiller un salon sp√©cifique, et isoler les transmissions.",
                    "La barre de recherche. Entrez des identifiants ou des balises pour filtrer la base de donn√©es.",
                    "L'outil de d√©ploiement. Cliquez dessus pour ouvrir le CONVERTISSEUR automatique.",
                    "Ins√©rez vos fichiers MP4 ici pour les convertir au format MPGIF exclusif de notre syst√®me.",
                    "La commande d'√©clairage. Indispensable pour ne pas fatiguer vos yeux pendant l'analyse des donn√©es.",
                    "C'est ici que vous injectez du contenu. Cliquez sur UPLOAD pour configurer un d√©ploiement.",
                    "Les modules d'envoi. Assurez-vous d'approuver les envois de qualit√© avant leur traitement.",
                    "Voici la base documentaire. Ce sont les modules d'archive o√π s'afficheront les vid√©os.",
                    "Faisons un essai √©ducatif. Vous pouvez utiliser les boutons de cette archive pour voter (+/-), l'ajouter aux favoris (√âtoile) ou l'envoyer sur Discord (clic image) !",
                    "Pour r√©viser ce tutoriel, utilisez le bouton Aide [?] dans la barre de navigation.",
                    "Enfin, veuillez prendre connaissance de l'Acte de Non-Licence situ√© en bas de page. C'est un manifeste de bonne foi pour ce fan-projet. Cliquez dessus.",
                    "Merci d'avoir lu. Ce n'est pas un r√®glement strict mais un rappel bienveillant. Fin du briefing !"
                ],
                veteran: [
                    "Te revoil√†, Op√©rateur d'√âlite ! Pr√™t √† optimiser la base de donn√©es avec moi ?",
                    "Ton dossier de carri√®re t'attend. Clique sur ton ic√¥ne de profil en haut √† droite.",
                    "Et voil√† ! Tu peux ici comparer tes exploits avec le reste de l'√©quipe et voir les membres enregistr√©s.",
                    "N'oublie pas le s√©lecteur de canal. Clique sur le bouton LINK pour ouvrir les acc√®s serveurs.",
                    "Exactement ! C'est ici que tu peux filtrer le brouhaha du r√©seau et te concentrer sur un salon pr√©cis.",
                    "Un fichier pr√©cis en t√™te ? Utilise cette barre de recherche pour trouver ce qu'il te faut.",
                    "Ici se trouve le Conversion Center ! Vas-y, clique dessus.",
                    "Pratique n'est-ce pas ? Tu peux y glisser des dizaines de MP4 et tout convertir en format MPGIF d'un simple clic !",
                    "Clair ou Sombre ? Tu connais la chanson, le bouton de transition optique est l√† ! Attention aux yeux.",
                    "Allez, clique sur UPLOAD en haut, notre base a encore besoin de tes archives !",
                    "C'est ici que tu peux nous envoyer tout tes MPGIF pr√™ts √† l'emploi.",
                    "Et voici la galerie ! C'est ici qu'appara√Ætront toutes les archives classifi√©es.",
                    "Vas-y essaie ! Vote avec les fl√®ches, met ce MPGIF en favori avec l'√©toile, ou clique sur l'image pour le balancer dans ton salon Discord !",
                    "Si tu as un trou de m√©moire, clique sur le bouton [?] en haut pour me rappeler. Je serai l√† !",
                    "Derni√®re chose : le lien d'Acte de Non-Licence en bas de page. C'est vital pour prouver qu'on est un projet de fan √† but non lucratif, clique dessus.",
                    "C'est juste un rappel amical, prend le temps de le lire √† l'occasion. Allez, au travail !"
                ],
                casual: [
                    "Salut, nouvelle recrue ! Bienvenue √† Endfield Industries. Je suis Ember, ton guide pour le Terminal Visuel.",
                    "Ici c'est ton bouton de Profil Op√©rateur. Vas-y, clique dessus pour l'ouvrir !",
                    "G√©nial ! Tes statistiques, tes badges secrets et la liste de tes coll√®gues s'y trouvent. Sympa non ?",
                    "On va parler serveurs virtuels. Clique sur le bouton LINK en haut pour d√©rouler le menu.",
                    "En plein dans le mille ! Tu peux maintenant filtrer facilement les vid√©os par serveur ou salon vocal.",
                    "La barre de recherche SEARCH DATABASE permet de trouver une vid√©o en scannant ses tags ou son nom.",
                    "Le syst√®me n'accepte que les .mpgif, alors ce bouton vers le Convertisseur sera ton meilleur ami ! Clique !",
                    "Tu pourras y convertir facilement tes vid√©os MP4 traditionnelles au format reconnu du Terminal !",
                    "Il fait un peu sombre ? Ce bouton permet d'inverser les th√®mes Clair et Sombre de l'interface.",
                    "Ce gros bouton permet d'apporter tes propres archives. Clique dessus pour y acc√©der !",
                    "Fantastique. Tu pourras nous envoyer ici tes pr√©cieuses animations MPGIF pour les partager avec tout le monde.",
                    "Voil√† la galerie principale, celle o√π appara√Ætront toutes les vid√©os !",
                    "Essaie les boutons de cette archive ! L'√âtoile pour tes favoris, les fl√®ches pour les votes... Et clique sur l'image pour l'envoyer direct sur Discord !",
                    "Tu as tout compris ! Si tu veux revoir ce tutoriel plus tard, tu pourras y r√©acc√©der via le petit bouton [?] en haut.",
                    "Pour finir, clique sur le bouton de l'Acte de Non-Licence en bas de l'√©cran. C'est pour rappeler la bonne foi de ce Fan-Projet communautaire !",
                    "Ce n'est pas un r√®glement agressif, juste un rappel bienveillant ! Sur ce, amuse-toi bien sur le Terminal MPGIF !"
                ]
            };
            return text[tone];
        }

        function startTutorial() {
            const strings = getTutorialStrings();

            // Temporary release of the header's strict stacking context so its children can be brought above the tutorial mask
            const h = document.querySelector('header');
            if (h) h.style.zIndex = 'auto';

            tutSteps = [
                // 0: Welcome
                { target: null, img: "posing-ember.png", text: strings[0] },
                // 1: Profile Trigger
                {
                    target: ".nav-profile", img: "glasses-ember-satisfied.png", text: strings[1], requireClick: true,
                    onEnter: () => { document.getElementById('profileModal').style.display = 'none'; }
                },
                // 2: Profile Modal
                {
                    target: ".operator-file", img: "glasses-ember-satisfied.png", text: strings[2],
                    onLeave: () => { document.getElementById('profileModal').style.display = 'none'; }
                },
                // 3: Server Trigger
                {
                    target: "#serverTrigger", img: "ember-right-direction.png", text: strings[3], requireClick: true,
                    chibiPos: { left: -360, top: 10 },
                    onEnter: () => {
                        const p = document.getElementById('serverPanel'); if (p) p.classList.remove('visible');
                        const t = document.getElementById('serverTrigger'); if (t) t.classList.remove('active');
                    }
                },
                // 4: Server Panel
                {
                    target: "#serverPanel", img: "ember-right-direction.png", text: strings[4],
                    chibiPos: { left: -360, top: 200 },
                    onLeave: () => {
                        const p = document.getElementById('serverPanel'); if (p) p.classList.remove('visible');
                        const t = document.getElementById('serverTrigger'); if (t) t.classList.remove('active');
                    }
                },
                // 5: Search Bar
                { target: "#searchInput", img: "switching-ember.png", text: strings[5], chibiPos: { left: 10, top: 80 } },
                // 6: Converter Trigger
                {
                    target: "#converterBtn", img: "arguying-ember.png", text: strings[6], requireClick: true,
                    chibiPos: { left: -100, top: 80 },
                    onEnter: () => { document.getElementById('converterModal').style.display = 'none'; }
                },
                // 7: Converter Modal
                {
                    target: "#converterModal .dossier-panel", img: "happy-ember.png", text: strings[7],
                    onLeave: () => { document.getElementById('converterModal').style.display = 'none'; }
                },
                // 8: Theme Btn
                { target: "#themeBtn", img: "switching-ember.png", text: strings[8], chibiPos: { left: -50, top: 80 } },
                // 9: Upload Trigger
                {
                    target: "#uploadBtn", img: "applausing-ember.png", text: strings[9], requireClick: true,
                    chibiPos: { left: -120, top: 80 },
                    onEnter: () => { document.getElementById('uploadModal').style.display = 'none'; }
                },
                // 10: Upload Modal
                {
                    target: "#uploadModal .dossier-panel", img: "applausing-ember.png", text: strings[10],
                    onLeave: () => { document.getElementById('uploadModal').style.display = 'none'; }
                },
                // 11: Gallery Section
                { target: "#s-shorts .section-title", img: "happy-ember.png", text: strings[11], chibiPos: { left: 50, top: -200 } },
                // 12: Feature explanation (First Gallery Card test interaction)
                { target: ".gallery-grid .card", img: "posing-ember.png", text: strings[12], chibiPos: { left: 30, top: -250 } },
                // 13: Help button replay
                { target: "#helpBtn", img: "glasses-ember-satisfied.png", text: strings[13], chibiPos: { left: -60, top: 80 } },
                // 14: Disclaimer Trigger
                {
                    target: "#disclaimerBtn", img: "arguying-ember.png", text: strings[14], requireClick: true,
                    onEnter: () => { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); document.getElementById('disclaimerModal').style.display = 'none'; }
                },
                // 15: Disclaimer Modal
                {
                    target: "#disclaimerModal .dossier-panel", img: "glasses-ember-satisfied.png", text: strings[15],
                    onLeave: () => { document.getElementById('disclaimerModal').style.display = 'none'; window.scrollTo({ top: 0, behavior: 'smooth' }); }
                }
            ];

            currTut = 0;
            document.getElementById('tutorial-overlay').classList.add('active');
            renderTutStep();
        }

        function renderTutStep(oldIndex = -1) {
            if (oldIndex >= 0 && oldIndex < tutSteps.length && tutSteps[oldIndex].onLeave) {
                tutSteps[oldIndex].onLeave();
            }

            // Clean old highlights and clicks
            document.querySelectorAll('.tut-highlight').forEach(el => {
                el.classList.remove('tut-highlight');
                if (tutClickHandler) el.removeEventListener('click', tutClickHandler);
            });
            tutClickHandler = null;

            if (currTut >= tutSteps.length) { skipTutorial(); return; }

            const step = tutSteps[currTut];

            if (step.onEnter) {
                step.onEnter();
            }

            const hole = document.getElementById('tutorial-hole');
            const floatingChibi = document.getElementById('tut-chibi-floating');

            const btnNext = document.getElementById('tut-btn-next');
            if (step.requireClick) {
                btnNext.style.display = 'none';
            } else {
                btnNext.style.display = 'block';
                btnNext.textContent = (currTut === tutSteps.length - 1) ? "FINISH" : "NEXT ‚ñ∂";
            }

            // Highlight new target
            if (step.target) {
                let el = null;
                if (step.queryAll) {
                    const match = document.querySelectorAll(step.target)[1];
                    if (match) el = match;
                } else if (document.querySelector(step.target)) {
                    el = document.querySelector(step.target);
                }

                if (el) {
                    el.classList.add('tut-highlight');

                    if (step.requireClick) {
                        tutClickHandler = function () {
                            setTimeout(() => tutNext(), 250);
                        };
                        el.addEventListener('click', tutClickHandler, { once: true });
                    }

                    // Don't scroll to center if it's a fixed header trigger to avoid jumping
                    if (step.target !== "#serverTrigger" && step.target !== ".nav-profile" && step.target !== "#uploadBtn" && step.target !== "#themeBtn") {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    setTimeout(() => {
                        const rect = el.getBoundingClientRect();

                        // Spotlight Hole position
                        hole.style.width = (rect.width + 16) + 'px';
                        hole.style.height = (rect.height + 16) + 'px';
                        hole.style.left = (rect.left - 8) + 'px';
                        hole.style.top = (rect.top - 8) + 'px';
                        hole.style.opacity = '1';

                        // Smart Chibi Position
                        floatingChibi.style.transform = 'none';

                        if (step.chibiPos) {
                            floatingChibi.style.left = (rect.right + step.chibiPos.left) + 'px';
                            floatingChibi.style.top = (rect.top + step.chibiPos.top) + 'px';
                        } else {
                            if (rect.left > window.innerWidth / 2) {
                                floatingChibi.style.left = Math.max(10, rect.left - 270) + 'px';
                            } else {
                                floatingChibi.style.left = (rect.right + 10) + 'px';
                            }

                            if (rect.top > window.innerHeight / 2) {
                                floatingChibi.style.top = (rect.top - 200) + 'px';
                            } else {
                                floatingChibi.style.top = rect.top + 'px';
                            }
                        }
                    }, 350);
                }
            } else {
                // First step - Center chibi, hide hole
                hole.style.opacity = '0';
                hole.style.width = '0px'; hole.style.height = '0px';
                hole.style.left = '50%'; hole.style.top = '50%';

                floatingChibi.style.transform = 'translate(-50%, -100%)';
                floatingChibi.style.left = '50%';
                floatingChibi.style.top = '50%';
            }

            // Update Dialog
            document.getElementById('tut-chibi').src = chibiPath + step.img;
            document.getElementById('tut-text').innerHTML = step.text;
            document.getElementById('tut-btn-prev').style.display = (currTut === 0) ? 'none' : 'block';
        }

        function tutNext() { let old = currTut; currTut++; renderTutStep(old); }
        function tutPrev() { let old = currTut; currTut--; renderTutStep(old); }

        function skipTutorial() {
            if (currTut >= 0 && currTut < tutSteps.length && tutSteps[currTut].onLeave) {
                tutSteps[currTut].onLeave();
            }

            // Restore header stacking context
            const h = document.querySelector('header');
            if (h) h.style.zIndex = '100';

            document.getElementById('tutorial-overlay').classList.remove('active');
            document.getElementById('tutorial-hole').style.opacity = '0';
            document.getElementById('tut-chibi-floating').style.opacity = '0';
            document.querySelectorAll('.tut-highlight').forEach(el => {
                el.classList.remove('tut-highlight');
                if (tutClickHandler) el.removeEventListener('click', tutClickHandler);
            });
            localStorage.setItem('mpgif_tutorial_completed', 'true');
        }

        // Delay tutorial boot slightly to ensure components (like user state) load first
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!localStorage.getItem('mpgif_tutorial_completed')) {
                    startTutorial();
                }
            }, 1500);
        });
    </script>
</body>

</html>